<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹»æƒ³æ‰‹è´¦ UI (V9.2 - ç¨³å®šç‰ˆ)</title>
</head>
<body>
    <!-- UI will be dynamically generated by JS -->

<script>
// Use DOMContentLoaded to ensure the script runs after the HTML is loaded
document.addEventListener('DOMContentLoaded', () => {

    // =================================================================
    // 1. Data Definitions (V9.2 - Decoupled Architecture)
    // =================================================================
    const gameData = {
        date: { year: 1024, month: 4, day: 15 },
        mainStory: `æ¬¢è¿æ¥åˆ°å¹»æƒ³æ‰‹è´¦ã€‚`,
        player: {
            title: "æˆ‘çš„æ—¥å¿—",
            status: [
                { label: 'ğŸƒ å½“å‰è¡ŒåŠ¨', value: 'åœ¨å†’é™©å…¬ä¼šé‡Œå¯»æ‰¾æ–°çš„å§”æ‰˜ã€‚' },
                { label: 'ğŸ‘• ä»Šæ—¥ç©¿æ­', value: 'ä¾¿äºè¡ŒåŠ¨çš„æ—…è¡Œè€…å¥—è£…ã€‚' },
                { label: 'ğŸ’¬ å†…å¿ƒç‹¬ç™½', value: 'ä»Šå¤©ä¼šæœ‰ä»€ä¹ˆæœ‰è¶£çš„å†’é™©å‘¢ï¼Ÿ' },
                { label: 'âš”ï¸ è¶æ‰‹æ­¦å™¨', value: 'æ–°æ‰‹é•¿å‰‘ã€‚' }
            ],
            stats: { hp: 100, maxHp: 100, mp: 100, maxMp: 100 },
            location: 'å†’é™©å…¬ä¼š', 
            currentLocationKey: 'å†’é™©å…¬ä¼š'
        },
        equipment: { weapon: 'æ–°æ‰‹é•¿å‰‘', armor: 'çš®è´¨ä¸Šè¡£', pants: 'äºšéº»å¸ƒçŸ­è£¤', boots: 'è½¯çš®çŸ­é´', accessory: 'æ— ' },
        skills: [
            { name: 'åˆçº§æ²»ç–—æœ¯' },
            { name: 'é£åˆƒ' }
        ],
        territory: {
            gold: 10000,
            buildings: [ 'ç‚¼é‡‘å·¥åŠ', 'ç§äººå›¾ä¹¦é¦†' ]
        },
        inventory: [
            { name: 'æ²»ç–—è¯æ°´(å°)', icon: 'ğŸ§ª' },
            { name: 'é¾™é³', icon: 'ğŸ”°' }
        ],
        npcs: [
            { name: 'è‰¾æ‹‰', affection: 85, trust: 70 },
            { name: 'é›·æ©', affection: 40, trust: 55 }
        ],
        lore: [], // To be populated from worldBookData
        map: {
            pois: [] // To be populated from worldBookData
        }
    };

    // =================================================================
    // 2. Static World Book Data (Frontend Copy)
    // =================================================================
    const worldBookData = {
        npcDetails: {
            'è‰¾æ‹‰': { bio: 'æ¸©æŸ”å–„è‰¯çš„ç²¾çµæƒ…æŠ¥å®˜ã€‚æ“…é•¿æ”¶é›†ä¿¡æ¯å’Œè¿œç¨‹æ”¯æ´ï¼Œä¼¼ä¹åœ¨å¯»æ‰¾ç€ä»€ä¹ˆé‡è¦çš„äººã€‚' },
            'é›·æ©': { bio: 'æ€§æ ¼æ²‰ç¨³çš„å‰ç‹å›½éª‘å£«ï¼Œå› ä¸ºæŸäº›åŸå› ç¦»å¼€äº†éª‘å£«å›¢ï¼Œç°åœ¨æ˜¯ä¸€åä½£å…µã€‚å‰‘æœ¯é«˜è¶…ã€‚' }
        },
        locationInteractions: {
            'å¤œå¹•é…’é¦†': {
                title: 'å¤œå¹•é…’é¦†äº’åŠ¨',
                functions: [
                    { label: 'ç‚¹é¤', action: "showStaticPanel('downtown_bar_menu')" },
                    { label: 'ä½å®¿', action: "showStaticPanel('downtown_lodging')" },
                    { label: 'æ‰“å¬æ¶ˆæ¯', action: "requestRumor()" }
                ],
                presentNPCs: ['è‰¾æ‹‰', 'é›·æ©'] 
            },
            'å†’é™©å…¬ä¼š': {
                title: 'å†’é™©å…¬ä¼šäº’åŠ¨',
                functions: [
                    { label: 'æ¥å–ä»»åŠ¡', action: "requestQuests()" },
                    { label: 'æäº¤ä»»åŠ¡', action: "submitQuest()" }
                ],
                presentNPCs: ['é›·æ©']
            },
            'è£…å¤‡åº—': {
                title: 'è£…å¤‡åº—äº’åŠ¨',
                functions: [
                    { label: 'è´­ä¹°è£…å¤‡', action: "showStaticPanel('downtown_armor_shop')" }
                ],
                presentNPCs: []
            }
        },
        staticPanels: {
            'downtown_bar_menu': {
                type: 'menu',
                title: 'é…’é¦†èœå•',
                items: [
                    { name: 'éº¦é…’', price: 50, description: 'å£æ„Ÿé†‡åšï¼Œæ·±å—å†’é™©è€…å–œçˆ±ã€‚' },
                    { name: 'çƒ¤é¸¡', price: 120, description: 'å¤–çš®é…¥è„†ï¼Œè‚‰è´¨é²œå«©ã€‚' },
                    { name: 'ç‚–ç‰›è‚‰', price: 150, description: 'æ±¤æ±æµ“éƒï¼Œè‚‰è´¨é…¥çƒ‚ã€‚' },
                    { name: 'å¨å£«å¿Œ', price: 250, description: 'åœ¨æ©¡æœ¨æ¡¶ä¸­é™ˆé…¿çš„çƒˆé…’ã€‚' }
                ]
            },
            'downtown_armor_shop': {
                type: 'shop',
                title: 'è£…å¤‡åº—å•†å“',
                items: [
                    { name: 'ç²¾é’¢é•¿å‰‘ (Dçº§)', price: 1500, description: 'åšå›ºè€ç”¨ï¼Œå†’é™©è€…çš„æ ‡å‡†é…å¤‡ã€‚' },
                    { name: 'é”å­ç”² (Dçº§)', price: 1800, description: 'èƒ½æœ‰æ•ˆé˜²å¾¡åŠˆç å’Œç©¿åˆºä¼¤å®³ã€‚' },
                    { name: 'ç¬¦æ–‡æ³•æ– (Cçº§)', price: 3500, description: 'èƒ½å¢å¹…åŸºç¡€é­”æ³•å¨åŠ›ã€‚' },
                    { name: 'ç›—è´¼è½¯ç”² (Cçº§)', price: 3000, description: 'è½»ä¾¿ï¼Œä¸å½±å“æ•æ·ã€‚' }
                ]
            },
            'downtown_lodging': {
                type: 'lodging',
                title: 'ä½å®¿é€‰é¡¹',
                items: [
                    { name: 'é…’é¦†å®¢æˆ¿', price: 200, description: 'å¹²å‡€æ•´æ´ï¼Œä½†å¯èƒ½æœ‰ç‚¹åµé—¹ã€‚', action: "restForNight(200)" },
                    { name: 'å•†ä¸šæ—…åº—', price: 500, description: 'å®‰é™èˆ’é€‚ï¼ŒæœåŠ¡å‘¨åˆ°ã€‚', action: "restForNight(500)" }
                ]
            }
        },
        loreCategories: [
            {
                category: 'ä¸–ç•Œè®¾å®š',
                entries: [
                    { title: 'æ—¶é’ˆäº¤å‰ä¹‹åŸ', content: 'ä¸€åº§è§„æ¨¡ç­‰åŒäºç‹å›½çš„å·¨å¤§éƒ½å¸‚ã€‚åŸåŒºç§‘æŠ€ä¸é­”æ³•é«˜åº¦å‘è¾¾ï¼ŒåŸå¤–åˆ™ä¿ç•™ç€åŸå§‹ä¸è½åçš„é£è²Œã€‚è¿™é‡Œæ˜¯å¤šæ¬¡å…ƒå­˜åœ¨çš„äº¤æ±‡ä¹‹åœ°ï¼Œç°ä»£æ‘©å¤©æ¥¼ä¸å¥‡å¹»é…’é¦†å…¬ä¼šå¹¶å­˜ã€‚' },
                    { title: 'å¹»æƒ³ä¹¡', content: 'ä½äºåŸå¸‚ä¹‹å¤–ï¼Œè¢«â€œåšä¸½å¤§ç»“ç•Œâ€æ‰€ç¬¼ç½©çš„ç‹¬ç«‹åŒºåŸŸï¼Œæ˜¯å¦–æ€ªã€ç¥æ˜ä¸å°‘æ•°äººç±»å…±å­˜çš„ä¸–å¤–æ¡ƒæºã€‚' }
                ]
            },
            {
                category: 'ç»„ç»‡åŠ¿åŠ›',
                entries: [
                    { title: 'å†’é™©å…¬ä¼š', content: 'å†’é™©è€…ä»¬æ¥å–ä»»åŠ¡ã€ç»„å»ºé˜Ÿä¼ã€äº¤æ¢æƒ…æŠ¥çš„æ ¸å¿ƒæ¢çº½ã€‚å…¬ä¼šä¼šå¯¹ä»»åŠ¡è¿›è¡Œè¯„çº§ï¼Œå¹¶ä»ä¸­æŠ½å–å°‘é‡ä½£é‡‘ã€‚' },
                    { title: 'å‰‘å£«åä¼š', content: 'æä¾›å‰‘æœ¯è®­ç»ƒã€è½¬èŒã€æŠ€èƒ½è®¤è¯çš„å®˜æ–¹æœºæ„ã€‚' }
                ]
            },
            {
                category: 'ç‰©å“åˆ†çº§',
                entries: [
                    { title: 'åˆ†çº§åˆ¶åº¦', content: 'ç‰©å“ä»ä¸Šåˆ°ä¸‹ä¾æ¬¡åˆ†ä¸ºï¼šè§„æ ¼å¤–, æ ¹æºçº§, EXçº§, SSSçº§, SS, S, A, B, C, D, E, Nã€‚Bçº§ä»¥ä¸Šåˆ†ä¸º+å’Œ-ã€‚' }
                ]
            }
        ],
        buildingIncome: {
            'ç‚¼é‡‘å·¥åŠ': 50000, 'é­”æ™¶å†œåœº': 80000, 'ç§äººå›¾ä¹¦é¦†': 0, 'è®­ç»ƒåœº': 0, 'çŸ¿æ´': 120000,
            'æ¸©æ³‰æ—…èˆ': 60000, 'å…½æ ': 20000, 'è´¸æ˜“ç«™': 150000, 'ç­æœ›å¡”': 0, 'ç¥é¾›': 0
        },
        mapPois: [
            { name: 'è½é­„è¡—', zone: 'slums', x: 15, y: 10 }, { name: 'è´«æ°‘çªŸ', zone: 'slums', x: 80, y: 12 }, { name: 'é£æœˆåœ°', zone: 'slums', x: 8, y: 30 }, { name: 'ç¦åˆ©é™¢', zone: 'slums', x: 88, y: 35 }, { name: 'å°åƒè¡—', zone: 'slums', x: 10, y: 80 }, { name: 'ä½£å…µè¥', zone: 'slums', x: 45, y: 90 }, { name: 'ä½£å…µé…’é¦†', zone: 'slums', x: 65, y: 92 }, { name: 'æ‚è´§åº—', zone: 'slums', x: 85, y: 85 },
            { name: 'å¸‚æ°‘åŒº', zone: 'downtown', x: 28, y: 25 }, { name: 'å‰‘å£«åä¼š', zone: 'downtown', x: 48, y: 22 }, { name: 'æ³•å¸ˆå·¥ä¼š', zone: 'downtown', x: 68, y: 25 }, { name: 'ç¥åœ£æ•™å ‚', zone: 'downtown', x: 25, y: 45 }, { name: 'å†’é™©å…¬ä¼š', zone: 'downtown', x: 50, y: 50 }, { name: 'é“å…·åº—', zone: 'downtown', x: 72, y: 45 }, { name: 'è£…å¤‡åº—', zone: 'downtown', x: 28, y: 75 }, { name: 'æ­¦å™¨é“º', zone: 'downtown', x: 48, y: 78 }, { name: 'å¤œå¹•é…’é¦†', zone: 'downtown', x: 68, y: 75 }, { name: 'ç¾é£Ÿè¡—', zone: 'downtown', x: 48, y: 60 },
            { name: 'çš‡å®«', zone: 'uptown', x: 50, y: 40 }, { name: 'è¡Œæ”¿é™¢', zone: 'uptown', x: 35, y: 50 }, { name: 'è´µæ—åŒº', zone: 'uptown', x: 65, y: 50 }, { name: 'ä¸€å“æ¥¼', zone: 'uptown', x: 40, y: 30 }, { name: 'å¤©ä¸Šäººé—´', zone: 'uptown', x: 60, y: 30 }, { name: 'å¸å›½å¤§å¦', zone: 'uptown', x: 30, y: 65 }, { name: 'å¸å›½é…’åº—', zone: 'uptown', x: 70, y: 65 }, { name: 'å¤©æµ·æ¥¼', zone: 'uptown', x: 40, y: 75 }, { name: 'å“è½©æ¥¼', zone: 'uptown', x: 60, y: 75 }, { name: 'è¾‰ç…Œè¡—', zone: 'uptown', x: 50, y: 20 },
        ]
    };

    gameData.map.pois = worldBookData.mapPois;
    gameData.lore = worldBookData.loreCategories;

    // =================================================================
    // 3. CSS Styles
    // =================================================================
    function applyStyles() {
        const styles = `
            @import url('https://fonts.googleapis.com/css2?family=ZCOOL+QingKe+HuangYou&family=Noto+Serif+SC:wght@400;700&display=swap');
            :root {
                --bg-color: #FFF0F5; --grid-color: rgba(230, 194, 201, 0.5); --parchment-bg: #FFFBF5;
                --ink-color: #4E4452; --highlight-color: #D87093; --border-color: #E6C2C9;
                --font-main: 'Noto Serif SC', serif; --font-header: 'ZCOOL QingKe HuangYou', cursive;
                --bottom-bar-height: 50px;
            }
            body { background-color: var(--bg-color); background-image: linear-gradient(var(--grid-color) 1px, transparent 1px), linear-gradient(90deg, var(--grid-color) 1px, transparent 1px); background-size: 20px 20px; margin: 0; padding: 2rem; font-family: var(--font-main); color: var(--ink-color); overflow: hidden; padding-bottom: calc(var(--bottom-bar-height) + 2rem); }
            * { user-select: none; box-sizing: border-box; }
            .time-display { position: fixed; top: 20px; right: 30px; font-family: var(--font-header); font-size: 1.2rem; color: var(--highlight-color); z-index: 10; }
            .parchment-container { background-color: var(--parchment-bg); padding: 2.5rem 3rem; border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); max-width: 800px; min-height: 400px; margin: 2rem auto; position: relative; font-size: 1.1rem; line-height: 2; }
            #player-status-toggle { position: absolute; top: -15px; left: 20px; width: 50px; height: 50px; background: #FDF5E6; border: 1px solid var(--border-color); border-radius: 50%; cursor: pointer; font-size: 1.8rem; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; z-index: 10; }
            #player-status-toggle:hover { transform: scale(1.1) rotate(-5deg); }
            .side-panel { position: fixed; left: 20px; width: 250px; height: 35vh; background-color: var(--parchment-bg); box-shadow: 0 0 20px rgba(0,0,0,0.2); padding: 1.5rem; overflow-y: auto; border-radius: 8px; z-index: 100; opacity: 0; visibility: hidden; transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
            .side-panel.from-top { top: 5vh; transform: translateX(-110%); }
            .side-panel.from-bottom { bottom: 75px; transform: translateX(-110%); }
            .side-panel.visible { opacity: 1; visibility: visible; transform: translateX(0); }
            .side-panel h2, .bottom-panel h2 { font-family: var(--font-header); color: var(--highlight-color); text-align: center; font-size: 2rem; margin: 0 0 1rem; border-bottom: 2px solid var(--border-color); padding-bottom: 0.5rem; }
            .status-item { margin-bottom: 1rem; }
            .status-item strong { display: block; font-size: 0.9rem; opacity: 0.7; margin-bottom: 4px; }
            .inventory-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 20px; margin-top: 1.5rem; }
            .inventory-item { display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer; padding: 10px; border-radius: 5px; transition: background-color 0.2s; }
            .inventory-item:hover { background-color: #f0e8dd; }
            .inventory-item .icon { font-size: 2.5rem; }
            .equipment-list { margin-top: 1.5rem; }
            .equipment-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px dashed var(--border-color); }
            .bottom-bar { position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; justify-content: center; align-items: center; gap: 5px; background-color: rgba(255, 240, 245, 0.85); backdrop-filter: blur(8px); border: 1px solid var(--border-color); z-index: 101; padding: 5px 10px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
            .bottom-bar-handle { padding: 0 15px; height: 40px; line-height: 40px; border-radius: 8px; transition: all 0.2s ease-out; background-color: transparent; color: var(--highlight-color); cursor:pointer; font-family: var(--font-header); }
            .bottom-bar-handle:hover { background-color: var(--highlight-color); color: white; transform: translateY(-2px); }
            .bottom-panel { position: fixed; bottom: 75px; left: 50%; width: 95%; max-width: 900px; max-height: 80vh; overflow-y: auto; background: var(--parchment-bg); border: 1px solid var(--border-color); border-radius: 10px; box-shadow: 0 -5px 20px rgba(0,0,0,0.15); padding: 1.5rem; z-index: 100; visibility: hidden; opacity: 0; transform: translateX(-50%) translateY(20px); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s, visibility 0s 0.4s; }
            .bottom-panel.visible { visibility: visible; opacity: 1; transform: translateX(-50%) translateY(0); transition-delay: 0s; }
            .npc-grid, .lore-grid, .skill-grid, .lore-category-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; margin-top: 1rem; }
            .npc-button, .lore-button, .skill-button, .lore-category-button { background: white; border: 1px solid var(--border-color); border-radius: 5px; padding: 10px; text-align: center; cursor: pointer; transition: all 0.2s ease; font-family: var(--font-main); font-size: 1rem;}
            .npc-button:hover, .lore-button:hover, .skill-button:hover, .lore-category-button:hover { transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
            .bio-text { font-style: italic; color: #888; padding: 8px; background: #f9f9f9; border-radius: 4px; }
            .close-btn { position: absolute; top: 10px; right: 15px; font-size: 2rem; color: #aaa; cursor: pointer; }
            .back-btn { position: absolute; top: 20px; left: 20px; font-size: 1.5rem; color: #aaa; cursor: pointer; text-decoration: none; }
            .progress-bar { width: 100%; height: 18px; background-color: #f0f0f0; border-radius: 9px; overflow: hidden; margin-top: 4px; }
            .progress-bar-fill { height: 100%; background-color: #ffb6c1; border-radius: 9px; text-align: right; color: white; font-size: 0.8rem; line-height: 18px; padding-right: 8px; }
            .hud-container-left, .hud-container-right { position: fixed; bottom: 15px; display: flex; flex-direction: column; gap: 10px; z-index: 90; background-color: rgba(255, 251, 245, 0.7); backdrop-filter: blur(4px); padding: 10px 15px; border-radius: 8px; border: 1px solid var(--border-color); box-shadow: 0 2px 5px rgba(0,0,0,0.1); font-family: var(--font-header); }
            .hud-container-left { left: 15px; font-size: 1.4rem; color: #DAA520; }
            .hud-container-right { right: 15px; width: 180px; }
            .hud-bar { width: 100%; height: 15px; background-color: #e0e0e0; border-radius: 7px; overflow: hidden; position: relative; border: 1px solid rgba(0,0,0,0.1); }
            .hud-bar-text { position: absolute; width: 100%; text-align: center; font-size: 0.85rem; line-height: 15px; color: white; text-shadow: 1px 1px 1px #333; z-index: 2; }
            .hud-bar-fill { position: absolute; height: 100%; border-radius: 6px; z-index: 1; }
            .hud-bar-fill.hp { background-color: #E35D6A; }
            .hud-bar-fill.mp { background-color: #5D9CEC; }
            #map-panel { max-height: 32vh; }
            .map-panel-content { width: 100%; height: calc(32vh - 80px); position: relative; background: #e8dccf; border-radius: 5px; overflow: hidden; margin-top: 1rem; }
            .map-zone { position: absolute; border: 2px dashed rgba(0,0,0,0.2); }
            .zone-label { position: absolute; font-family: var(--font-header); font-size: 1.5rem; opacity: 0.3; pointer-events: none; color: #fff; text-shadow: 1px 1px 2px #555; }
            .map-poi { position: absolute; transform: translate(-50%, -50%); background: var(--parchment-bg); padding: 2px 6px; border-radius: 4px; border: 1px solid var(--border-color); font-size: 0.8rem; white-space: nowrap; transition: all 0.2s; pointer-events: none; }
            #player-marker { position: absolute; transform: translate(-50%, -50%); font-size: 1.5rem; color: red; z-index: 5; pointer-events: none; transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
            #scene-interaction-button { position: absolute; bottom: 20px; right: 20px; background-color: var(--highlight-color); color: white; font-family: var(--font-header); font-size: 1rem; padding: 10px 20px; border-radius: 20px; border: none; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: all 0.3s ease; z-index: 5; display: none; }
            #scene-interaction-button:hover { background-color: #c76383; transform: translateY(-2px); }
            .static-panel-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
            .static-panel-item { background: #fff; border: 1px solid var(--border-color); padding: 15px; border-radius: 5px; cursor: pointer; transition: all 0.2s ease; }
            .static-panel-item:hover { transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
            .static-panel-item h3 { margin: 0 0 5px; font-family: var(--font-header); color: var(--highlight-color); }
            .static-panel-item p { margin: 0; font-size: 0.9rem; color: #777; }
            .static-panel-item .price { font-weight: bold; color: var(--ink-color); margin-top: 10px; display: block; }
        `;
        const styleSheet = document.createElement("style");
        styleSheet.innerText = styles;
        document.head.appendChild(styleSheet);
    }

    // =================================================================
    // 4. Core Interaction Logic
    // =================================================================
    const panelManager = {
        panels: {},
        register(id, element) { this.panels[id] = element; },
        closeAll() { Object.values(this.panels).forEach(el => el.classList.remove('visible')); },
        toggle(id) {
            const targetPanel = this.panels[id];
            if (!targetPanel) return;
            const isVisible = targetPanel.classList.contains('visible');
            this.closeAll();
            if (!isVisible) {
                if (id === 'map-panel') drawMap();
                if (id === 'lore-category-panel') showLoreCategories(); // Ensure refresh on open
                targetPanel.classList.add('visible');
            }
        }
    };

    function createDOM() {
        const body = document.body;
        const create = (tag, id, className) => { const el = document.createElement(tag); if (id) el.id = id; if (className) el.className = className; return el; };

        // --- Create all UI elements ---
        const hudLeft = create('div', 'hud-left', 'hud-container-left');
        body.appendChild(hudLeft);

        const hudRight = create('div', 'hud-right', 'hud-container-right');
        body.appendChild(hudRight);

        const timeDisplay = create('div', 'time-display', 'time-display');
        body.appendChild(timeDisplay);

        const parchment = create('div', 'parchment-container', 'parchment-container');
        parchment.innerHTML = `<p>${gameData.mainStory}</p>`;
        const playerToggle = create('button', 'player-status-toggle', 'player-status-toggle');
        playerToggle.innerHTML = 'ğŸ“œ';
        parchment.appendChild(playerToggle);
        const interactionButton = create('button', 'scene-interaction-button', 'scene-interaction-button');
        interactionButton.textContent = 'åœºæ™¯äº’åŠ¨';
        parchment.appendChild(interactionButton);
        body.appendChild(parchment);

        const playerPanel = create('div', 'player-panel', 'side-panel');
        body.appendChild(playerPanel);

        const mapPanel = create('div', 'map-panel', 'bottom-panel');
        body.appendChild(mapPanel);

        const interactionPanel = create('div', 'interaction-panel', 'bottom-panel');
        body.appendChild(interactionPanel);
        
        const staticDetailPanel = create('div', 'static-detail-panel', 'bottom-panel');
        body.appendChild(staticDetailPanel);

        const inventoryTray = create('div', 'inventory-tray', 'bottom-panel');
        body.appendChild(inventoryTray);

        const npcTray = create('div', 'npc-tray', 'bottom-panel');
        body.appendChild(npcTray);

        const npcStatusPanel = create('div', 'npc-status-panel', 'bottom-panel');
        body.appendChild(npcStatusPanel);

        const loreCategoryPanel = create('div', 'lore-category-panel', 'bottom-panel');
        const loreListPanel = create('div', 'lore-list-panel', 'bottom-panel');
        const loreDetailPanel = create('div', 'lore-detail-panel', 'bottom-panel');
        body.appendChild(loreCategoryPanel);
        body.appendChild(loreListPanel);
        body.appendChild(loreDetailPanel);

        const equipmentPanel = create('div', 'equipment-panel', 'bottom-panel');
        body.appendChild(equipmentPanel);

        const skillsTray = create('div', 'skills-tray', 'bottom-panel');
        body.appendChild(skillsTray);

        const bottomBar = create('div', 'bottom-bar', 'bottom-bar');
        const buttons = [ { name: 'åœ°å›¾', panel: 'map-panel' }, { name: 'æ—¥å¿—', panel: 'player-panel' }, { name: 'è£…å¤‡', panel: 'equipment-panel' }, { name: 'èƒŒåŒ…', panel: 'inventory-tray' }, { name: 'æŠ€èƒ½', panel: 'skills-tray' }, { name: 'NPC', panel: 'npc-tray' }, { name: 'èµ„æ–™', panel: 'lore-category-panel' } ];
        buttons.forEach(btn => { const handle = create('div', null, 'bottom-bar-handle'); handle.textContent = btn.name; handle.dataset.panelId = btn.panel; bottomBar.appendChild(handle); });
        body.appendChild(bottomBar);

        // --- Register all manageable panels ---
        panelManager.register('player-panel', playerPanel);
        panelManager.register('map-panel', mapPanel);
        panelManager.register('inventory-tray', inventoryTray);
        panelManager.register('npc-tray', npcTray);
        panelManager.register('npc-status-panel', npcStatusPanel);
        panelManager.register('lore-category-panel', loreCategoryPanel);
        panelManager.register('lore-list-panel', loreListPanel);
        panelManager.register('lore-detail-panel', loreDetailPanel);
        panelManager.register('equipment-panel', equipmentPanel);
        panelManager.register('skills-tray', skillsTray);
        panelManager.register('interaction-panel', interactionPanel);
        panelManager.register('static-detail-panel', staticDetailPanel);
        
        // --- Initialize UI display ---
        updateHud();
        updatePlayerPanel();
        updateInventoryPanel();
        updateSkillsPanel();
        updateEquipmentPanel();
        updateNpcListPanel();
    }

    function attachListeners() {
        // --- Core buttons and global click ---
        document.getElementById('player-status-toggle').addEventListener('click', (e) => {
            e.stopPropagation();
            panelManager.toggle('player-panel');
        });

        document.querySelector('.bottom-bar').addEventListener('click', (e) => {
            if (e.target.classList.contains('bottom-bar-handle')) {
                e.stopPropagation();
                panelManager.toggle(e.target.dataset.panelId);
            }
        });

        document.getElementById('scene-interaction-button').addEventListener('click', (e) => {
            e.stopPropagation();
            showInteractionPanel(gameData.player.currentLocationKey);
        });

        document.body.addEventListener('click', (e) => {
            const target = e.target;
            if (!target.closest('.side-panel, .bottom-panel, .bottom-bar, .player-status-toggle, .scene-interaction-button')) {
                panelManager.closeAll();
            }
        });
        
        // --- Click logic for individual panels ---
        const interactionPanel = document.getElementById('interaction-panel');
        if (interactionPanel) interactionPanel.addEventListener('click', handleInteractionClick);
        
        const staticDetailPanel = document.getElementById('static-detail-panel');
        if (staticDetailPanel) staticDetailPanel.addEventListener('click', handleInteractionClick);
        
        const loreCategoryPanel = document.getElementById('lore-category-panel');
        if(loreCategoryPanel) loreCategoryPanel.addEventListener('click', (e) => {
            const target = e.target.closest('.lore-category-button');
            if (target) {
                e.stopPropagation();
                showLoreList(target.dataset.category);
            }
        });

        const loreListPanel = document.getElementById('lore-list-panel');
        if(loreListPanel) loreListPanel.addEventListener('click', (e) => {
            const target = e.target.closest('.lore-button');
            if (target) {
                e.stopPropagation();
                const title = target.dataset.title;
                const category = target.dataset.category;
                const loreData = worldBookData.loreCategories.find(c => c.category === category)
                    ?.entries.find(l => l.title === title);
                if (loreData) showLoreDetail(loreData, category);
            } else if (e.target.closest('.back-btn')) {
                e.stopPropagation();
                panelManager.toggle('lore-category-panel');
            }
        });

        const loreDetailPanel = document.getElementById('lore-detail-panel');
        if(loreDetailPanel) loreDetailPanel.addEventListener('click', (e) => {
            const target = e.target.closest('.back-btn');
             if (target) {
                e.stopPropagation();
                showLoreList(target.dataset.category);
            } else if (e.target.closest('.close-btn')) {
                e.stopPropagation();
                panelManager.closeAll();
            }
        });

        const npcTray = document.getElementById('npc-tray');
        if(npcTray) npcTray.addEventListener('click', (e) => {
            const target = e.target.closest('.npc-button');
            if (target) {
                e.stopPropagation();
                showNpcPanel(target.dataset.name);
            }
        });
        
        const npcStatusPanel = document.getElementById('npc-status-panel');
        if(npcStatusPanel) npcStatusPanel.addEventListener('click', (e) => {
            if (e.target.closest('.close-btn')) {
                e.stopPropagation();
                panelManager.closeAll();
            }
        });
    }

    // =================================================================
    // 5. UI Update and Rendering Functions
    // =================================================================
    function updateHud() {
        document.getElementById('hud-left').innerHTML = `ğŸ’° ${gameData.territory.gold.toLocaleString()}`;
        const { hp, maxHp, mp, maxMp } = gameData.player.stats;
        document.getElementById('hud-right').innerHTML = `
            <div class="hud-bar">
                <div class="hud-bar-text">HP: ${hp} / ${maxHp}</div>
                <div class="hud-bar-fill hp" style="width: ${hp/maxHp*100}%"></div>
            </div>
            <div class="hud-bar">
                <div class="hud-bar-text">MP: ${mp} / ${maxMp}</div>
                <div class="hud-bar-fill mp" style="width: ${mp/maxMp*100}%"></div>
            </div>`;
        document.getElementById('time-display').textContent = `${gameData.date.year}å¹´${gameData.date.month}æœˆ${gameData.date.day}æ—¥`;
    }

    function updatePlayerPanel() {
        const playerPanel = document.getElementById('player-panel');
        if(playerPanel) playerPanel.innerHTML = `<h2>${gameData.player.title}</h2>` + gameData.player.status.map(item => `<div class="status-item"><strong>${item.label}</strong><span>${item.value}</span></div>`).join('');
    }
    
    function updateInventoryPanel() {
        const inventoryTray = document.getElementById('inventory-tray');
        if(inventoryTray) inventoryTray.innerHTML = `<h2>èƒŒåŒ…</h2><div class="inventory-grid">${gameData.inventory.map(item => `<div class="inventory-item" data-name="${item.name}"><span class="icon">${item.icon}</span><span class="name">${item.name}</span></div>`).join('')}</div>`;
    }
    
    function updateSkillsPanel() {
        const skillsTray = document.getElementById('skills-tray');
        if(skillsTray) skillsTray.innerHTML = `<h2>æŠ€èƒ½åˆ—è¡¨</h2><div class="skill-grid">${gameData.skills.map(skill => `<button class="skill-button" data-name="${skill.name}">${skill.name}</button>`).join('')}</div>`;
    }
    
    function updateEquipmentPanel() {
        const equipmentPanel = document.getElementById('equipment-panel');
        if(equipmentPanel) {
            let equipmentHtml = '<h2>æˆ‘çš„è£…å¤‡</h2><div class="equipment-list">';
            for (const [slot, item] of Object.entries(gameData.equipment)) { equipmentHtml += `<div class="equipment-item"><strong>${slot.charAt(0).toUpperCase() + slot.slice(1)}</strong><span>${item}</span></div>`; }
            equipmentPanel.innerHTML = equipmentHtml + '</div>';
        }
    }

    function updateNpcListPanel() {
        const npcTray = document.getElementById('npc-tray');
        if(npcTray) npcTray.innerHTML = `<h2>NPCåˆ—è¡¨</h2><div class="npc-grid">${gameData.npcs.map(npc => `<button class="npc-button" data-name="${npc.name}">${npc.name}</button>`).join('')}</div>`;
    }

    // =================================================================
    // 6. Core Functions (Dynamic/Static Interaction)
    // =================================================================

    // --- Economy and Time ---
    function updateGold(amount) {
        gameData.territory.gold += amount;
        updateHud();
    }

    function processMonthlyIncome() {
        let totalIncome = 0;
        gameData.territory.buildings.forEach(buildingName => {
            totalIncome += worldBookData.buildingIncome[buildingName] || 0;
        });
        updateGold(totalIncome);
        const storyP = document.querySelector('#parchment-container p');
        if(storyP) storyP.innerHTML += `<br><small style="color: green;"><i>[ç³»ç»Ÿæç¤ºï¼šé¢†åœ°æœˆåº¦æ”¶å…¥ ${totalIncome.toLocaleString()}G å·²åˆ°è´¦ã€‚]</i></small>`;
    }

    function advanceTime(daysToAdvance = 1) {
        for (let i = 0; i < daysToAdvance; i++) {
            let daysInMonth = new Date(gameData.date.year, gameData.date.month, 0).getDate();
            gameData.date.day++;
            if (gameData.date.day > daysInMonth) {
                gameData.date.day = 1;
                gameData.date.month++;
                if (gameData.date.month > 12) {
                    gameData.date.month = 1;
                    gameData.date.year++;
                }
            }
            if (gameData.date.day === 1) processMonthlyIncome();
        }
        updateHud();
    }

    // --- Scene and Interaction ---
    function enterScene(locationKey, storyText) {
        gameData.player.currentLocationKey = locationKey;
        const storyP = document.querySelector('#parchment-container p');
        const interactionButton = document.getElementById('scene-interaction-button');
        
        if (storyP) storyP.innerHTML = storyText; 
        
        if (interactionButton) {
            if (worldBookData.locationInteractions[locationKey]) {
                interactionButton.style.display = 'block';
            } else {
                interactionButton.style.display = 'none';
            }
        }
        updatePlayerLocation(locationKey);
    }

    function showInteractionPanel(locationKey) {
        const interactionData = worldBookData.locationInteractions[locationKey];
        if (!interactionData) return;

        const panel = document.getElementById('interaction-panel');
        let contentHtml = `<span class="close-btn">&times;</span><h2>${interactionData.title}</h2><div class="static-panel-grid">`;
        
        interactionData.functions.forEach(func => {
            contentHtml += `<div class="static-panel-item" data-action="${func.action}"><h3>${func.label}</h3></div>`;
        });

        const storyText = document.querySelector('#parchment-container p')?.innerText || "";
        worldBookData.npcDetails && Object.keys(worldBookData.npcDetails).forEach(npcName => {
            if (storyText.includes(npcName)) {
                 contentHtml += `<div class="static-panel-item" data-action="showNpcPanel('${npcName}')"><h3>ä¸ ${npcName} äº¤è°ˆ</h3></div>`;
            }
        });

        panel.innerHTML = contentHtml + `</div>`;
        panelManager.toggle('interaction-panel');
    }
    
    function handleInteractionClick(e) {
        const target = e.target.closest('[data-action]');
        if (target && target.dataset.action) {
            e.stopPropagation();
            try {
                // Safely execute function from string
                new Function(target.dataset.action)();
            } catch (error) {
                console.error("Error executing action:", error);
            }
        } else if (e.target.closest('.close-btn')) {
            e.stopPropagation();
            panelManager.closeAll();
        }
    }

    function showStaticPanel(panelKey) {
        const panelData = worldBookData.staticPanels[panelKey];
        if (!panelData) return;
        
        const panel = document.getElementById('static-detail-panel');
        let contentHtml = `<span class="close-btn">&times;</span><h2>${panelData.title}</h2><div class="static-panel-grid">`;
        
        panelData.items.forEach(item => {
            let action = '';
            if (panelData.type === 'menu' || panelData.type === 'shop') {
                action = `buyItem('${item.name}', ${item.price})`;
            } else if (panelData.type === 'lodging') {
                action = item.action;
            }
            contentHtml += `<div class="static-panel-item" data-action="${action}">
                <h3>${item.name}</h3>
                <p>${item.description}</p>
                <span class="price">ä»·æ ¼: ${item.price.toLocaleString()}G</span>
            </div>`;
        });
        
        panel.innerHTML = contentHtml + `</div>`;
        panelManager.toggle('static-detail-panel');
    }

    function buyItem(itemName, price) {
        if (gameData.territory.gold >= price) {
            updateGold(-price);
            addItemToInventory(itemName, 'ğŸ›’');
            const storyP = document.querySelector('#parchment-container p');
            if(storyP) storyP.innerHTML += `<br><small style="color: blue;"><i>[ç³»ç»Ÿæç¤ºï¼šä½ è´­ä¹°äº† ${itemName}ã€‚]</i></small>`;
        } else {
            const storyP = document.querySelector('#parchment-container p');
            if(storyP) storyP.innerHTML += `<br><small style="color: red;"><i>[ç³»ç»Ÿæç¤ºï¼šé‡‘å¸ä¸è¶³ï¼]</i></small>`;
        }
    }

    function restForNight(price) {
        if (gameData.territory.gold >= price) {
            updateGold(-price);
            const storyP = document.querySelector('#parchment-container p');
            if(storyP) storyP.innerHTML = `<p>ä½ æ”¯ä»˜äº† ${price}G å¹¶ä¼‘æ¯äº†ä¸€æ™šã€‚</p>`; // Reset story text
            advanceTime(1);
            if(storyP) storyP.innerHTML += `<br><small style="color: purple;"><i>[ç³»ç»ŸæŒ‡ä»¤ï¼šç”¨æˆ·å·²ä¼‘æ¯å®Œæ¯•ã€‚ç°åœ¨æ˜¯æ–°çš„ä¸€å¤©: ${gameData.date.day}æ—¥ã€‚è¯·ç›´æ¥å¼€å§‹æè¿°ç¬¬äºŒå¤©çš„æ—©æ™¨ã€‚]</i></small>`;
            panelManager.closeAll();
        } else {
            const storyP = document.querySelector('#parchment-container p');
            if(storyP) storyP.innerHTML += `<br><small style="color: red;"><i>[ç³»ç»Ÿæç¤ºï¼šé‡‘å¸ä¸è¶³ï¼Œæ— æ³•åœ¨æ­¤ä¼‘æ¯ï¼]</i></small>`;
        }
    }
    
    // --- Items/Skills/NPCs ---
    function addItemToInventory(itemName, itemIcon = 'â“') {
        if (!gameData.inventory.some(item => item.name === itemName)) {
            gameData.inventory.push({ name: itemName, icon: itemIcon });
            updateInventoryPanel();
        }
    }
    
    function removeItemFromInventory(itemName) {
        gameData.inventory = gameData.inventory.filter(item => item.name !== itemName);
        updateInventoryPanel();
    }

    function showNpcPanel(npcName) {
        const npc = gameData.npcs.find(n => n.name === npcName);
        if (!npc) return;
        const staticInfo = worldBookData.npcDetails[npc.name] || { bio: 'æš‚æ— æ­¤äººçš„è¯¦ç»†ä¿¡æ¯ã€‚' };
        const panel = document.getElementById('npc-status-panel');
        let contentHtml = `<span class="close-btn">&times;</span><h2>${npc.name}</h2>`;
        contentHtml += `<div class="status-item"><strong>ğŸ’“ å¥½æ„Ÿåº¦</strong><div class="progress-bar"><div class="progress-bar-fill" style="width: ${npc.affection}%;">${npc.affection}</div></div></div>`;
        contentHtml += `<div class="status-item"><strong>â­ ä¿¡èµ–åº¦</strong><div class="progress-bar"><div class="progress-bar-fill" style="width: ${npc.trust}%; background-color: #5D9CEC;">${npc.trust}</div></div></div>`;
        contentHtml += `<div class="status-item"><strong>ğŸ“ ç®€ä»‹</strong><div class="bio-text">${staticInfo.bio}</div></div>`;
        panel.innerHTML = contentHtml;
        panelManager.toggle('npc-status-panel');
    }

    // --- Lore Encyclopedia ---
    function showLoreCategories() {
        const panel = document.getElementById('lore-category-panel');
        let contentHtml = `<h2>èµ„æ–™æŸ¥è¯¢</h2><div class="lore-category-grid">`;
        worldBookData.loreCategories.forEach(cat => {
            contentHtml += `<button class="lore-category-button" data-category="${cat.category}">${cat.category}</button>`;
        });
        panel.innerHTML = contentHtml + `</div>`;
    }

    function showLoreList(category) {
        const categoryData = worldBookData.loreCategories.find(c => c.category === category);
        if (!categoryData) return;
        const panel = document.getElementById('lore-list-panel');
        let contentHtml = `<a href="#" class="back-btn">&larr;</a><h2>${category}</h2><div class="lore-grid">`;
        categoryData.entries.forEach(entry => {
            contentHtml += `<button class="lore-button" data-title="${entry.title}" data-category="${category}">${entry.title}</button>`;
        });
        panel.innerHTML = contentHtml + `</div>`;
        panelManager.toggle('lore-list-panel');
    }
    
    function showLoreDetail(lore, category) {
        const panel = document.getElementById('lore-detail-panel');
        panel.innerHTML = `<span class="close-btn">&times;</span><a href="#" class="back-btn" data-category="${category}">&larr;</a><h2>${lore.title}</h2><div class="status-item" style="line-height: 1.8;"><p>${lore.content}</p></div>`;
        panelManager.toggle('lore-detail-panel');
    }

    // --- Map ---
    function drawMap() {
        const mapContent = document.querySelector('#map-panel .map-panel-content');
        if (!mapContent) return;
        mapContent.innerHTML = '';
        const create = (tag, id, className) => { const el = document.createElement(tag); if (id) el.id = id; if (className) el.className = className; return el; };
        const zones = { slums: { x: '5%', y: '5%', w: '90%', h: '90%', bg: '#d3c4a2', label: 'è´«æ°‘åŒº' }, downtown: { x: '20%', y: '20%', w: '60%', h: '60%', bg: '#c1b291', label: 'ä¸‹åŸåŒº' }, uptown: { x: '35%', y: '35%', w: '30%', h: '30%', bg: '#b0a180', label: 'ä¸ŠåŸåŒº' } };
        Object.values(zones).forEach(z => { const zoneEl = create('div', null, 'map-zone'); zoneEl.style.cssText = `left:${z.x}; top:${z.y}; width:${z.w}; height:${z.h}; background-color:${z.bg};`; zoneEl.innerHTML = `<div class="zone-label" style="top:5px; left:5px;">${z.label}</div>`; mapContent.appendChild(zoneEl); });
        gameData.map.pois.forEach(poi => { const poiEl = create('div', null, 'map-poi'); poiEl.textContent = poi.name; poiEl.style.left = `${poi.x}%`; poiEl.style.top = `${poi.y}%`; mapContent.appendChild(poiEl); });
        const playerMarker = create('div', 'player-marker', null);
        playerMarker.textContent = 'ğŸ“';
        mapContent.appendChild(playerMarker);
        updatePlayerMarker();
    }

    function updatePlayerMarker() {
        const marker = document.getElementById('player-marker');
        const poiData = gameData.map.pois.find(p => p.name === gameData.player.location);
        if (marker && poiData) { marker.style.left = `${poiData.x}%`; marker.style.top = `${poi.y}%`; }
    }

    function updatePlayerLocation(newLocationName) {
        if (gameData.map.pois.some(p => p.name === newLocationName)) {
            gameData.player.location = newLocationName;
            if (document.getElementById('map-panel')?.classList.contains('visible')) {
                updatePlayerMarker();
            }
        }
    }

    // =================================================================
    // 7. Initialization and Global Exposure
    // =================================================================
    function init() {
        // This is the engine starter, ensuring strict execution order
        applyStyles();      // 1. Apply all styles
        createDOM();        // 2. Create all DOM elements in memory
        attachListeners();  // 3. Bind events to the created DOM elements
        
        // --- Expose functions to be called by AI to the global scope ---
        window.enterScene = enterScene;
        window.updateGold = updateGold;
        window.addItemToInventory = addItemToInventory;
        window.removeItemFromInventory = removeItemFromInventory;
        window.advanceTime = advanceTime;
        // ... other functions to be exposed in the future
    }

    // --- Start! ---
    init();

}); // DOMContentLoaded end
</script>

</body>
</html>
