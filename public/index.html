<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>幻想手账 UI (V9.2 - 稳定版)</title>
</head>
<body>
    <!-- UI will be dynamically generated by JS -->

<script>
// Use DOMContentLoaded to ensure the script runs after the HTML is loaded
document.addEventListener('DOMContentLoaded', () => {

    // =================================================================
    // 1. Data Definitions (V9.2 - Decoupled Architecture)
    // =================================================================
    const gameData = {
        date: { year: 1024, month: 4, day: 15 },
        mainStory: `欢迎来到幻想手账。`,
        player: {
            title: "我的日志",
            status: [
                { label: '🏃 当前行动', value: '在冒险公会里寻找新的委托。' },
                { label: '👕 今日穿搭', value: '便于行动的旅行者套装。' },
                { label: '💬 内心独白', value: '今天会有什么有趣的冒险呢？' },
                { label: '⚔️ 趁手武器', value: '新手长剑。' }
            ],
            stats: { hp: 100, maxHp: 100, mp: 100, maxMp: 100 },
            location: '冒险公会', 
            currentLocationKey: '冒险公会'
        },
        equipment: { weapon: '新手长剑', armor: '皮质上衣', pants: '亚麻布短裤', boots: '软皮短靴', accessory: '无' },
        skills: [
            { name: '初级治疗术' },
            { name: '风刃' }
        ],
        territory: {
            gold: 10000,
            buildings: [ '炼金工坊', '私人图书馆' ]
        },
        inventory: [
            { name: '治疗药水(小)', icon: '🧪' },
            { name: '龙鳞', icon: '🔰' }
        ],
        npcs: [
            { name: '艾拉', affection: 85, trust: 70 },
            { name: '雷恩', affection: 40, trust: 55 }
        ],
        lore: [], // To be populated from worldBookData
        map: {
            pois: [] // To be populated from worldBookData
        }
    };

    // =================================================================
    // 2. Static World Book Data (Frontend Copy)
    // =================================================================
    const worldBookData = {
        npcDetails: {
            '艾拉': { bio: '温柔善良的精灵情报官。擅长收集信息和远程支援，似乎在寻找着什么重要的人。' },
            '雷恩': { bio: '性格沉稳的前王国骑士，因为某些原因离开了骑士团，现在是一名佣兵。剑术高超。' }
        },
        locationInteractions: {
            '夜幕酒馆': {
                title: '夜幕酒馆互动',
                functions: [
                    { label: '点餐', action: "showStaticPanel('downtown_bar_menu')" },
                    { label: '住宿', action: "showStaticPanel('downtown_lodging')" },
                    { label: '打听消息', action: "requestRumor()" }
                ],
                presentNPCs: ['艾拉', '雷恩'] 
            },
            '冒险公会': {
                title: '冒险公会互动',
                functions: [
                    { label: '接取任务', action: "requestQuests()" },
                    { label: '提交任务', action: "submitQuest()" }
                ],
                presentNPCs: ['雷恩']
            },
            '装备店': {
                title: '装备店互动',
                functions: [
                    { label: '购买装备', action: "showStaticPanel('downtown_armor_shop')" }
                ],
                presentNPCs: []
            }
        },
        staticPanels: {
            'downtown_bar_menu': {
                type: 'menu',
                title: '酒馆菜单',
                items: [
                    { name: '麦酒', price: 50, description: '口感醇厚，深受冒险者喜爱。' },
                    { name: '烤鸡', price: 120, description: '外皮酥脆，肉质鲜嫩。' },
                    { name: '炖牛肉', price: 150, description: '汤汁浓郁，肉质酥烂。' },
                    { name: '威士忌', price: 250, description: '在橡木桶中陈酿的烈酒。' }
                ]
            },
            'downtown_armor_shop': {
                type: 'shop',
                title: '装备店商品',
                items: [
                    { name: '精钢长剑 (D级)', price: 1500, description: '坚固耐用，冒险者的标准配备。' },
                    { name: '锁子甲 (D级)', price: 1800, description: '能有效防御劈砍和穿刺伤害。' },
                    { name: '符文法杖 (C级)', price: 3500, description: '能增幅基础魔法威力。' },
                    { name: '盗贼软甲 (C级)', price: 3000, description: '轻便，不影响敏捷。' }
                ]
            },
            'downtown_lodging': {
                type: 'lodging',
                title: '住宿选项',
                items: [
                    { name: '酒馆客房', price: 200, description: '干净整洁，但可能有点吵闹。', action: "restForNight(200)" },
                    { name: '商业旅店', price: 500, description: '安静舒适，服务周到。', action: "restForNight(500)" }
                ]
            }
        },
        loreCategories: [
            {
                category: '世界设定',
                entries: [
                    { title: '时针交叉之城', content: '一座规模等同于王国的巨大都市。城区科技与魔法高度发达，城外则保留着原始与落后的风貌。这里是多次元存在的交汇之地，现代摩天楼与奇幻酒馆公会并存。' },
                    { title: '幻想乡', content: '位于城市之外，被“博丽大结界”所笼罩的独立区域，是妖怪、神明与少数人类共存的世外桃源。' }
                ]
            },
            {
                category: '组织势力',
                entries: [
                    { title: '冒险公会', content: '冒险者们接取任务、组建队伍、交换情报的核心枢纽。公会会对任务进行评级，并从中抽取少量佣金。' },
                    { title: '剑士协会', content: '提供剑术训练、转职、技能认证的官方机构。' }
                ]
            },
            {
                category: '物品分级',
                entries: [
                    { title: '分级制度', content: '物品从上到下依次分为：规格外, 根源级, EX级, SSS级, SS, S, A, B, C, D, E, N。B级以上分为+和-。' }
                ]
            }
        ],
        buildingIncome: {
            '炼金工坊': 50000, '魔晶农场': 80000, '私人图书馆': 0, '训练场': 0, '矿洞': 120000,
            '温泉旅舍': 60000, '兽栏': 20000, '贸易站': 150000, '瞭望塔': 0, '神龛': 0
        },
        mapPois: [
            { name: '落魄街', zone: 'slums', x: 15, y: 10 }, { name: '贫民窟', zone: 'slums', x: 80, y: 12 }, { name: '风月地', zone: 'slums', x: 8, y: 30 }, { name: '福利院', zone: 'slums', x: 88, y: 35 }, { name: '小吃街', zone: 'slums', x: 10, y: 80 }, { name: '佣兵营', zone: 'slums', x: 45, y: 90 }, { name: '佣兵酒馆', zone: 'slums', x: 65, y: 92 }, { name: '杂货店', zone: 'slums', x: 85, y: 85 },
            { name: '市民区', zone: 'downtown', x: 28, y: 25 }, { name: '剑士协会', zone: 'downtown', x: 48, y: 22 }, { name: '法师工会', zone: 'downtown', x: 68, y: 25 }, { name: '神圣教堂', zone: 'downtown', x: 25, y: 45 }, { name: '冒险公会', zone: 'downtown', x: 50, y: 50 }, { name: '道具店', zone: 'downtown', x: 72, y: 45 }, { name: '装备店', zone: 'downtown', x: 28, y: 75 }, { name: '武器铺', zone: 'downtown', x: 48, y: 78 }, { name: '夜幕酒馆', zone: 'downtown', x: 68, y: 75 }, { name: '美食街', zone: 'downtown', x: 48, y: 60 },
            { name: '皇宫', zone: 'uptown', x: 50, y: 40 }, { name: '行政院', zone: 'uptown', x: 35, y: 50 }, { name: '贵族区', zone: 'uptown', x: 65, y: 50 }, { name: '一品楼', zone: 'uptown', x: 40, y: 30 }, { name: '天上人间', zone: 'uptown', x: 60, y: 30 }, { name: '帝国大厦', zone: 'uptown', x: 30, y: 65 }, { name: '帝国酒店', zone: 'uptown', x: 70, y: 65 }, { name: '天海楼', zone: 'uptown', x: 40, y: 75 }, { name: '品轩楼', zone: 'uptown', x: 60, y: 75 }, { name: '辉煌街', zone: 'uptown', x: 50, y: 20 },
        ]
    };

    gameData.map.pois = worldBookData.mapPois;
    gameData.lore = worldBookData.loreCategories;

    // =================================================================
    // 3. CSS Styles
    // =================================================================
    function applyStyles() {
        const styles = `
            @import url('https://fonts.googleapis.com/css2?family=ZCOOL+QingKe+HuangYou&family=Noto+Serif+SC:wght@400;700&display=swap');
            :root {
                --bg-color: #FFF0F5; --grid-color: rgba(230, 194, 201, 0.5); --parchment-bg: #FFFBF5;
                --ink-color: #4E4452; --highlight-color: #D87093; --border-color: #E6C2C9;
                --font-main: 'Noto Serif SC', serif; --font-header: 'ZCOOL QingKe HuangYou', cursive;
                --bottom-bar-height: 50px;
            }
            body { background-color: var(--bg-color); background-image: linear-gradient(var(--grid-color) 1px, transparent 1px), linear-gradient(90deg, var(--grid-color) 1px, transparent 1px); background-size: 20px 20px; margin: 0; padding: 2rem; font-family: var(--font-main); color: var(--ink-color); overflow: hidden; padding-bottom: calc(var(--bottom-bar-height) + 2rem); }
            * { user-select: none; box-sizing: border-box; }
            .time-display { position: fixed; top: 20px; right: 30px; font-family: var(--font-header); font-size: 1.2rem; color: var(--highlight-color); z-index: 10; }
            .parchment-container { background-color: var(--parchment-bg); padding: 2.5rem 3rem; border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); max-width: 800px; min-height: 400px; margin: 2rem auto; position: relative; font-size: 1.1rem; line-height: 2; }
            #player-status-toggle { position: absolute; top: -15px; left: 20px; width: 50px; height: 50px; background: #FDF5E6; border: 1px solid var(--border-color); border-radius: 50%; cursor: pointer; font-size: 1.8rem; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; z-index: 10; }
            #player-status-toggle:hover { transform: scale(1.1) rotate(-5deg); }
            .side-panel { position: fixed; left: 20px; width: 250px; height: 35vh; background-color: var(--parchment-bg); box-shadow: 0 0 20px rgba(0,0,0,0.2); padding: 1.5rem; overflow-y: auto; border-radius: 8px; z-index: 100; opacity: 0; visibility: hidden; transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
            .side-panel.from-top { top: 5vh; transform: translateX(-110%); }
            .side-panel.from-bottom { bottom: 75px; transform: translateX(-110%); }
            .side-panel.visible { opacity: 1; visibility: visible; transform: translateX(0); }
            .side-panel h2, .bottom-panel h2 { font-family: var(--font-header); color: var(--highlight-color); text-align: center; font-size: 2rem; margin: 0 0 1rem; border-bottom: 2px solid var(--border-color); padding-bottom: 0.5rem; }
            .status-item { margin-bottom: 1rem; }
            .status-item strong { display: block; font-size: 0.9rem; opacity: 0.7; margin-bottom: 4px; }
            .inventory-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 20px; margin-top: 1.5rem; }
            .inventory-item { display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer; padding: 10px; border-radius: 5px; transition: background-color 0.2s; }
            .inventory-item:hover { background-color: #f0e8dd; }
            .inventory-item .icon { font-size: 2.5rem; }
            .equipment-list { margin-top: 1.5rem; }
            .equipment-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px dashed var(--border-color); }
            .bottom-bar { position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; justify-content: center; align-items: center; gap: 5px; background-color: rgba(255, 240, 245, 0.85); backdrop-filter: blur(8px); border: 1px solid var(--border-color); z-index: 101; padding: 5px 10px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
            .bottom-bar-handle { padding: 0 15px; height: 40px; line-height: 40px; border-radius: 8px; transition: all 0.2s ease-out; background-color: transparent; color: var(--highlight-color); cursor:pointer; font-family: var(--font-header); }
            .bottom-bar-handle:hover { background-color: var(--highlight-color); color: white; transform: translateY(-2px); }
            .bottom-panel { position: fixed; bottom: 75px; left: 50%; width: 95%; max-width: 900px; max-height: 80vh; overflow-y: auto; background: var(--parchment-bg); border: 1px solid var(--border-color); border-radius: 10px; box-shadow: 0 -5px 20px rgba(0,0,0,0.15); padding: 1.5rem; z-index: 100; visibility: hidden; opacity: 0; transform: translateX(-50%) translateY(20px); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s, visibility 0s 0.4s; }
            .bottom-panel.visible { visibility: visible; opacity: 1; transform: translateX(-50%) translateY(0); transition-delay: 0s; }
            .npc-grid, .lore-grid, .skill-grid, .lore-category-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; margin-top: 1rem; }
            .npc-button, .lore-button, .skill-button, .lore-category-button { background: white; border: 1px solid var(--border-color); border-radius: 5px; padding: 10px; text-align: center; cursor: pointer; transition: all 0.2s ease; font-family: var(--font-main); font-size: 1rem;}
            .npc-button:hover, .lore-button:hover, .skill-button:hover, .lore-category-button:hover { transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
            .bio-text { font-style: italic; color: #888; padding: 8px; background: #f9f9f9; border-radius: 4px; }
            .close-btn { position: absolute; top: 10px; right: 15px; font-size: 2rem; color: #aaa; cursor: pointer; }
            .back-btn { position: absolute; top: 20px; left: 20px; font-size: 1.5rem; color: #aaa; cursor: pointer; text-decoration: none; }
            .progress-bar { width: 100%; height: 18px; background-color: #f0f0f0; border-radius: 9px; overflow: hidden; margin-top: 4px; }
            .progress-bar-fill { height: 100%; background-color: #ffb6c1; border-radius: 9px; text-align: right; color: white; font-size: 0.8rem; line-height: 18px; padding-right: 8px; }
            .hud-container-left, .hud-container-right { position: fixed; bottom: 15px; display: flex; flex-direction: column; gap: 10px; z-index: 90; background-color: rgba(255, 251, 245, 0.7); backdrop-filter: blur(4px); padding: 10px 15px; border-radius: 8px; border: 1px solid var(--border-color); box-shadow: 0 2px 5px rgba(0,0,0,0.1); font-family: var(--font-header); }
            .hud-container-left { left: 15px; font-size: 1.4rem; color: #DAA520; }
            .hud-container-right { right: 15px; width: 180px; }
            .hud-bar { width: 100%; height: 15px; background-color: #e0e0e0; border-radius: 7px; overflow: hidden; position: relative; border: 1px solid rgba(0,0,0,0.1); }
            .hud-bar-text { position: absolute; width: 100%; text-align: center; font-size: 0.85rem; line-height: 15px; color: white; text-shadow: 1px 1px 1px #333; z-index: 2; }
            .hud-bar-fill { position: absolute; height: 100%; border-radius: 6px; z-index: 1; }
            .hud-bar-fill.hp { background-color: #E35D6A; }
            .hud-bar-fill.mp { background-color: #5D9CEC; }
            #map-panel { max-height: 32vh; }
            .map-panel-content { width: 100%; height: calc(32vh - 80px); position: relative; background: #e8dccf; border-radius: 5px; overflow: hidden; margin-top: 1rem; }
            .map-zone { position: absolute; border: 2px dashed rgba(0,0,0,0.2); }
            .zone-label { position: absolute; font-family: var(--font-header); font-size: 1.5rem; opacity: 0.3; pointer-events: none; color: #fff; text-shadow: 1px 1px 2px #555; }
            .map-poi { position: absolute; transform: translate(-50%, -50%); background: var(--parchment-bg); padding: 2px 6px; border-radius: 4px; border: 1px solid var(--border-color); font-size: 0.8rem; white-space: nowrap; transition: all 0.2s; pointer-events: none; }
            #player-marker { position: absolute; transform: translate(-50%, -50%); font-size: 1.5rem; color: red; z-index: 5; pointer-events: none; transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
            #scene-interaction-button { position: absolute; bottom: 20px; right: 20px; background-color: var(--highlight-color); color: white; font-family: var(--font-header); font-size: 1rem; padding: 10px 20px; border-radius: 20px; border: none; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: all 0.3s ease; z-index: 5; display: none; }
            #scene-interaction-button:hover { background-color: #c76383; transform: translateY(-2px); }
            .static-panel-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
            .static-panel-item { background: #fff; border: 1px solid var(--border-color); padding: 15px; border-radius: 5px; cursor: pointer; transition: all 0.2s ease; }
            .static-panel-item:hover { transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
            .static-panel-item h3 { margin: 0 0 5px; font-family: var(--font-header); color: var(--highlight-color); }
            .static-panel-item p { margin: 0; font-size: 0.9rem; color: #777; }
            .static-panel-item .price { font-weight: bold; color: var(--ink-color); margin-top: 10px; display: block; }
        `;
        const styleSheet = document.createElement("style");
        styleSheet.innerText = styles;
        document.head.appendChild(styleSheet);
    }

    // =================================================================
    // 4. Core Interaction Logic
    // =================================================================
    const panelManager = {
        panels: {},
        register(id, element) { this.panels[id] = element; },
        closeAll() { Object.values(this.panels).forEach(el => el.classList.remove('visible')); },
        toggle(id) {
            const targetPanel = this.panels[id];
            if (!targetPanel) return;
            const isVisible = targetPanel.classList.contains('visible');
            this.closeAll();
            if (!isVisible) {
                if (id === 'map-panel') drawMap();
                if (id === 'lore-category-panel') showLoreCategories(); // Ensure refresh on open
                targetPanel.classList.add('visible');
            }
        }
    };

    function createDOM() {
        const body = document.body;
        const create = (tag, id, className) => { const el = document.createElement(tag); if (id) el.id = id; if (className) el.className = className; return el; };

        // --- Create all UI elements ---
        const hudLeft = create('div', 'hud-left', 'hud-container-left');
        body.appendChild(hudLeft);

        const hudRight = create('div', 'hud-right', 'hud-container-right');
        body.appendChild(hudRight);

        const timeDisplay = create('div', 'time-display', 'time-display');
        body.appendChild(timeDisplay);

        const parchment = create('div', 'parchment-container', 'parchment-container');
        parchment.innerHTML = `<p>${gameData.mainStory}</p>`;
        const playerToggle = create('button', 'player-status-toggle', 'player-status-toggle');
        playerToggle.innerHTML = '📜';
        parchment.appendChild(playerToggle);
        const interactionButton = create('button', 'scene-interaction-button', 'scene-interaction-button');
        interactionButton.textContent = '场景互动';
        parchment.appendChild(interactionButton);
        body.appendChild(parchment);

        const playerPanel = create('div', 'player-panel', 'side-panel');
        body.appendChild(playerPanel);

        const mapPanel = create('div', 'map-panel', 'bottom-panel');
        body.appendChild(mapPanel);

        const interactionPanel = create('div', 'interaction-panel', 'bottom-panel');
        body.appendChild(interactionPanel);
        
        const staticDetailPanel = create('div', 'static-detail-panel', 'bottom-panel');
        body.appendChild(staticDetailPanel);

        const inventoryTray = create('div', 'inventory-tray', 'bottom-panel');
        body.appendChild(inventoryTray);

        const npcTray = create('div', 'npc-tray', 'bottom-panel');
        body.appendChild(npcTray);

        const npcStatusPanel = create('div', 'npc-status-panel', 'bottom-panel');
        body.appendChild(npcStatusPanel);

        const loreCategoryPanel = create('div', 'lore-category-panel', 'bottom-panel');
        const loreListPanel = create('div', 'lore-list-panel', 'bottom-panel');
        const loreDetailPanel = create('div', 'lore-detail-panel', 'bottom-panel');
        body.appendChild(loreCategoryPanel);
        body.appendChild(loreListPanel);
        body.appendChild(loreDetailPanel);

        const equipmentPanel = create('div', 'equipment-panel', 'bottom-panel');
        body.appendChild(equipmentPanel);

        const skillsTray = create('div', 'skills-tray', 'bottom-panel');
        body.appendChild(skillsTray);

        const bottomBar = create('div', 'bottom-bar', 'bottom-bar');
        const buttons = [ { name: '地图', panel: 'map-panel' }, { name: '日志', panel: 'player-panel' }, { name: '装备', panel: 'equipment-panel' }, { name: '背包', panel: 'inventory-tray' }, { name: '技能', panel: 'skills-tray' }, { name: 'NPC', panel: 'npc-tray' }, { name: '资料', panel: 'lore-category-panel' } ];
        buttons.forEach(btn => { const handle = create('div', null, 'bottom-bar-handle'); handle.textContent = btn.name; handle.dataset.panelId = btn.panel; bottomBar.appendChild(handle); });
        body.appendChild(bottomBar);

        // --- Register all manageable panels ---
        panelManager.register('player-panel', playerPanel);
        panelManager.register('map-panel', mapPanel);
        panelManager.register('inventory-tray', inventoryTray);
        panelManager.register('npc-tray', npcTray);
        panelManager.register('npc-status-panel', npcStatusPanel);
        panelManager.register('lore-category-panel', loreCategoryPanel);
        panelManager.register('lore-list-panel', loreListPanel);
        panelManager.register('lore-detail-panel', loreDetailPanel);
        panelManager.register('equipment-panel', equipmentPanel);
        panelManager.register('skills-tray', skillsTray);
        panelManager.register('interaction-panel', interactionPanel);
        panelManager.register('static-detail-panel', staticDetailPanel);
        
        // --- Initialize UI display ---
        updateHud();
        updatePlayerPanel();
        updateInventoryPanel();
        updateSkillsPanel();
        updateEquipmentPanel();
        updateNpcListPanel();
    }

    function attachListeners() {
        // --- Core buttons and global click ---
        document.getElementById('player-status-toggle').addEventListener('click', (e) => {
            e.stopPropagation();
            panelManager.toggle('player-panel');
        });

        document.querySelector('.bottom-bar').addEventListener('click', (e) => {
            if (e.target.classList.contains('bottom-bar-handle')) {
                e.stopPropagation();
                panelManager.toggle(e.target.dataset.panelId);
            }
        });

        document.getElementById('scene-interaction-button').addEventListener('click', (e) => {
            e.stopPropagation();
            showInteractionPanel(gameData.player.currentLocationKey);
        });

        document.body.addEventListener('click', (e) => {
            const target = e.target;
            if (!target.closest('.side-panel, .bottom-panel, .bottom-bar, .player-status-toggle, .scene-interaction-button')) {
                panelManager.closeAll();
            }
        });
        
        // --- Click logic for individual panels ---
        const interactionPanel = document.getElementById('interaction-panel');
        if (interactionPanel) interactionPanel.addEventListener('click', handleInteractionClick);
        
        const staticDetailPanel = document.getElementById('static-detail-panel');
        if (staticDetailPanel) staticDetailPanel.addEventListener('click', handleInteractionClick);
        
        const loreCategoryPanel = document.getElementById('lore-category-panel');
        if(loreCategoryPanel) loreCategoryPanel.addEventListener('click', (e) => {
            const target = e.target.closest('.lore-category-button');
            if (target) {
                e.stopPropagation();
                showLoreList(target.dataset.category);
            }
        });

        const loreListPanel = document.getElementById('lore-list-panel');
        if(loreListPanel) loreListPanel.addEventListener('click', (e) => {
            const target = e.target.closest('.lore-button');
            if (target) {
                e.stopPropagation();
                const title = target.dataset.title;
                const category = target.dataset.category;
                const loreData = worldBookData.loreCategories.find(c => c.category === category)
                    ?.entries.find(l => l.title === title);
                if (loreData) showLoreDetail(loreData, category);
            } else if (e.target.closest('.back-btn')) {
                e.stopPropagation();
                panelManager.toggle('lore-category-panel');
            }
        });

        const loreDetailPanel = document.getElementById('lore-detail-panel');
        if(loreDetailPanel) loreDetailPanel.addEventListener('click', (e) => {
            const target = e.target.closest('.back-btn');
             if (target) {
                e.stopPropagation();
                showLoreList(target.dataset.category);
            } else if (e.target.closest('.close-btn')) {
                e.stopPropagation();
                panelManager.closeAll();
            }
        });

        const npcTray = document.getElementById('npc-tray');
        if(npcTray) npcTray.addEventListener('click', (e) => {
            const target = e.target.closest('.npc-button');
            if (target) {
                e.stopPropagation();
                showNpcPanel(target.dataset.name);
            }
        });
        
        const npcStatusPanel = document.getElementById('npc-status-panel');
        if(npcStatusPanel) npcStatusPanel.addEventListener('click', (e) => {
            if (e.target.closest('.close-btn')) {
                e.stopPropagation();
                panelManager.closeAll();
            }
        });
    }

    // =================================================================
    // 5. UI Update and Rendering Functions
    // =================================================================
    function updateHud() {
        document.getElementById('hud-left').innerHTML = `💰 ${gameData.territory.gold.toLocaleString()}`;
        const { hp, maxHp, mp, maxMp } = gameData.player.stats;
        document.getElementById('hud-right').innerHTML = `
            <div class="hud-bar">
                <div class="hud-bar-text">HP: ${hp} / ${maxHp}</div>
                <div class="hud-bar-fill hp" style="width: ${hp/maxHp*100}%"></div>
            </div>
            <div class="hud-bar">
                <div class="hud-bar-text">MP: ${mp} / ${maxMp}</div>
                <div class="hud-bar-fill mp" style="width: ${mp/maxMp*100}%"></div>
            </div>`;
        document.getElementById('time-display').textContent = `${gameData.date.year}年${gameData.date.month}月${gameData.date.day}日`;
    }

    function updatePlayerPanel() {
        const playerPanel = document.getElementById('player-panel');
        if(playerPanel) playerPanel.innerHTML = `<h2>${gameData.player.title}</h2>` + gameData.player.status.map(item => `<div class="status-item"><strong>${item.label}</strong><span>${item.value}</span></div>`).join('');
    }
    
    function updateInventoryPanel() {
        const inventoryTray = document.getElementById('inventory-tray');
        if(inventoryTray) inventoryTray.innerHTML = `<h2>背包</h2><div class="inventory-grid">${gameData.inventory.map(item => `<div class="inventory-item" data-name="${item.name}"><span class="icon">${item.icon}</span><span class="name">${item.name}</span></div>`).join('')}</div>`;
    }
    
    function updateSkillsPanel() {
        const skillsTray = document.getElementById('skills-tray');
        if(skillsTray) skillsTray.innerHTML = `<h2>技能列表</h2><div class="skill-grid">${gameData.skills.map(skill => `<button class="skill-button" data-name="${skill.name}">${skill.name}</button>`).join('')}</div>`;
    }
    
    function updateEquipmentPanel() {
        const equipmentPanel = document.getElementById('equipment-panel');
        if(equipmentPanel) {
            let equipmentHtml = '<h2>我的装备</h2><div class="equipment-list">';
            for (const [slot, item] of Object.entries(gameData.equipment)) { equipmentHtml += `<div class="equipment-item"><strong>${slot.charAt(0).toUpperCase() + slot.slice(1)}</strong><span>${item}</span></div>`; }
            equipmentPanel.innerHTML = equipmentHtml + '</div>';
        }
    }

    function updateNpcListPanel() {
        const npcTray = document.getElementById('npc-tray');
        if(npcTray) npcTray.innerHTML = `<h2>NPC列表</h2><div class="npc-grid">${gameData.npcs.map(npc => `<button class="npc-button" data-name="${npc.name}">${npc.name}</button>`).join('')}</div>`;
    }

    // =================================================================
    // 6. Core Functions (Dynamic/Static Interaction)
    // =================================================================

    // --- Economy and Time ---
    function updateGold(amount) {
        gameData.territory.gold += amount;
        updateHud();
    }

    function processMonthlyIncome() {
        let totalIncome = 0;
        gameData.territory.buildings.forEach(buildingName => {
            totalIncome += worldBookData.buildingIncome[buildingName] || 0;
        });
        updateGold(totalIncome);
        const storyP = document.querySelector('#parchment-container p');
        if(storyP) storyP.innerHTML += `<br><small style="color: green;"><i>[系统提示：领地月度收入 ${totalIncome.toLocaleString()}G 已到账。]</i></small>`;
    }

    function advanceTime(daysToAdvance = 1) {
        for (let i = 0; i < daysToAdvance; i++) {
            let daysInMonth = new Date(gameData.date.year, gameData.date.month, 0).getDate();
            gameData.date.day++;
            if (gameData.date.day > daysInMonth) {
                gameData.date.day = 1;
                gameData.date.month++;
                if (gameData.date.month > 12) {
                    gameData.date.month = 1;
                    gameData.date.year++;
                }
            }
            if (gameData.date.day === 1) processMonthlyIncome();
        }
        updateHud();
    }

    // --- Scene and Interaction ---
    function enterScene(locationKey, storyText) {
        gameData.player.currentLocationKey = locationKey;
        const storyP = document.querySelector('#parchment-container p');
        const interactionButton = document.getElementById('scene-interaction-button');
        
        if (storyP) storyP.innerHTML = storyText; 
        
        if (interactionButton) {
            if (worldBookData.locationInteractions[locationKey]) {
                interactionButton.style.display = 'block';
            } else {
                interactionButton.style.display = 'none';
            }
        }
        updatePlayerLocation(locationKey);
    }

    function showInteractionPanel(locationKey) {
        const interactionData = worldBookData.locationInteractions[locationKey];
        if (!interactionData) return;

        const panel = document.getElementById('interaction-panel');
        let contentHtml = `<span class="close-btn">&times;</span><h2>${interactionData.title}</h2><div class="static-panel-grid">`;
        
        interactionData.functions.forEach(func => {
            contentHtml += `<div class="static-panel-item" data-action="${func.action}"><h3>${func.label}</h3></div>`;
        });

        const storyText = document.querySelector('#parchment-container p')?.innerText || "";
        worldBookData.npcDetails && Object.keys(worldBookData.npcDetails).forEach(npcName => {
            if (storyText.includes(npcName)) {
                 contentHtml += `<div class="static-panel-item" data-action="showNpcPanel('${npcName}')"><h3>与 ${npcName} 交谈</h3></div>`;
            }
        });

        panel.innerHTML = contentHtml + `</div>`;
        panelManager.toggle('interaction-panel');
    }
    
    function handleInteractionClick(e) {
        const target = e.target.closest('[data-action]');
        if (target && target.dataset.action) {
            e.stopPropagation();
            try {
                // Safely execute function from string
                new Function(target.dataset.action)();
            } catch (error) {
                console.error("Error executing action:", error);
            }
        } else if (e.target.closest('.close-btn')) {
            e.stopPropagation();
            panelManager.closeAll();
        }
    }

    function showStaticPanel(panelKey) {
        const panelData = worldBookData.staticPanels[panelKey];
        if (!panelData) return;
        
        const panel = document.getElementById('static-detail-panel');
        let contentHtml = `<span class="close-btn">&times;</span><h2>${panelData.title}</h2><div class="static-panel-grid">`;
        
        panelData.items.forEach(item => {
            let action = '';
            if (panelData.type === 'menu' || panelData.type === 'shop') {
                action = `buyItem('${item.name}', ${item.price})`;
            } else if (panelData.type === 'lodging') {
                action = item.action;
            }
            contentHtml += `<div class="static-panel-item" data-action="${action}">
                <h3>${item.name}</h3>
                <p>${item.description}</p>
                <span class="price">价格: ${item.price.toLocaleString()}G</span>
            </div>`;
        });
        
        panel.innerHTML = contentHtml + `</div>`;
        panelManager.toggle('static-detail-panel');
    }

    function buyItem(itemName, price) {
        if (gameData.territory.gold >= price) {
            updateGold(-price);
            addItemToInventory(itemName, '🛒');
            const storyP = document.querySelector('#parchment-container p');
            if(storyP) storyP.innerHTML += `<br><small style="color: blue;"><i>[系统提示：你购买了 ${itemName}。]</i></small>`;
        } else {
            const storyP = document.querySelector('#parchment-container p');
            if(storyP) storyP.innerHTML += `<br><small style="color: red;"><i>[系统提示：金币不足！]</i></small>`;
        }
    }

    function restForNight(price) {
        if (gameData.territory.gold >= price) {
            updateGold(-price);
            const storyP = document.querySelector('#parchment-container p');
            if(storyP) storyP.innerHTML = `<p>你支付了 ${price}G 并休息了一晚。</p>`; // Reset story text
            advanceTime(1);
            if(storyP) storyP.innerHTML += `<br><small style="color: purple;"><i>[系统指令：用户已休息完毕。现在是新的一天: ${gameData.date.day}日。请直接开始描述第二天的早晨。]</i></small>`;
            panelManager.closeAll();
        } else {
            const storyP = document.querySelector('#parchment-container p');
            if(storyP) storyP.innerHTML += `<br><small style="color: red;"><i>[系统提示：金币不足，无法在此休息！]</i></small>`;
        }
    }
    
    // --- Items/Skills/NPCs ---
    function addItemToInventory(itemName, itemIcon = '❓') {
        if (!gameData.inventory.some(item => item.name === itemName)) {
            gameData.inventory.push({ name: itemName, icon: itemIcon });
            updateInventoryPanel();
        }
    }
    
    function removeItemFromInventory(itemName) {
        gameData.inventory = gameData.inventory.filter(item => item.name !== itemName);
        updateInventoryPanel();
    }

    function showNpcPanel(npcName) {
        const npc = gameData.npcs.find(n => n.name === npcName);
        if (!npc) return;
        const staticInfo = worldBookData.npcDetails[npc.name] || { bio: '暂无此人的详细信息。' };
        const panel = document.getElementById('npc-status-panel');
        let contentHtml = `<span class="close-btn">&times;</span><h2>${npc.name}</h2>`;
        contentHtml += `<div class="status-item"><strong>💓 好感度</strong><div class="progress-bar"><div class="progress-bar-fill" style="width: ${npc.affection}%;">${npc.affection}</div></div></div>`;
        contentHtml += `<div class="status-item"><strong>⭐ 信赖度</strong><div class="progress-bar"><div class="progress-bar-fill" style="width: ${npc.trust}%; background-color: #5D9CEC;">${npc.trust}</div></div></div>`;
        contentHtml += `<div class="status-item"><strong>📝 简介</strong><div class="bio-text">${staticInfo.bio}</div></div>`;
        panel.innerHTML = contentHtml;
        panelManager.toggle('npc-status-panel');
    }

    // --- Lore Encyclopedia ---
    function showLoreCategories() {
        const panel = document.getElementById('lore-category-panel');
        let contentHtml = `<h2>资料查询</h2><div class="lore-category-grid">`;
        worldBookData.loreCategories.forEach(cat => {
            contentHtml += `<button class="lore-category-button" data-category="${cat.category}">${cat.category}</button>`;
        });
        panel.innerHTML = contentHtml + `</div>`;
    }

    function showLoreList(category) {
        const categoryData = worldBookData.loreCategories.find(c => c.category === category);
        if (!categoryData) return;
        const panel = document.getElementById('lore-list-panel');
        let contentHtml = `<a href="#" class="back-btn">&larr;</a><h2>${category}</h2><div class="lore-grid">`;
        categoryData.entries.forEach(entry => {
            contentHtml += `<button class="lore-button" data-title="${entry.title}" data-category="${category}">${entry.title}</button>`;
        });
        panel.innerHTML = contentHtml + `</div>`;
        panelManager.toggle('lore-list-panel');
    }
    
    function showLoreDetail(lore, category) {
        const panel = document.getElementById('lore-detail-panel');
        panel.innerHTML = `<span class="close-btn">&times;</span><a href="#" class="back-btn" data-category="${category}">&larr;</a><h2>${lore.title}</h2><div class="status-item" style="line-height: 1.8;"><p>${lore.content}</p></div>`;
        panelManager.toggle('lore-detail-panel');
    }

    // --- Map ---
    function drawMap() {
        const mapContent = document.querySelector('#map-panel .map-panel-content');
        if (!mapContent) return;
        mapContent.innerHTML = '';
        const create = (tag, id, className) => { const el = document.createElement(tag); if (id) el.id = id; if (className) el.className = className; return el; };
        const zones = { slums: { x: '5%', y: '5%', w: '90%', h: '90%', bg: '#d3c4a2', label: '贫民区' }, downtown: { x: '20%', y: '20%', w: '60%', h: '60%', bg: '#c1b291', label: '下城区' }, uptown: { x: '35%', y: '35%', w: '30%', h: '30%', bg: '#b0a180', label: '上城区' } };
        Object.values(zones).forEach(z => { const zoneEl = create('div', null, 'map-zone'); zoneEl.style.cssText = `left:${z.x}; top:${z.y}; width:${z.w}; height:${z.h}; background-color:${z.bg};`; zoneEl.innerHTML = `<div class="zone-label" style="top:5px; left:5px;">${z.label}</div>`; mapContent.appendChild(zoneEl); });
        gameData.map.pois.forEach(poi => { const poiEl = create('div', null, 'map-poi'); poiEl.textContent = poi.name; poiEl.style.left = `${poi.x}%`; poiEl.style.top = `${poi.y}%`; mapContent.appendChild(poiEl); });
        const playerMarker = create('div', 'player-marker', null);
        playerMarker.textContent = '📍';
        mapContent.appendChild(playerMarker);
        updatePlayerMarker();
    }

    function updatePlayerMarker() {
        const marker = document.getElementById('player-marker');
        const poiData = gameData.map.pois.find(p => p.name === gameData.player.location);
        if (marker && poiData) { marker.style.left = `${poiData.x}%`; marker.style.top = `${poi.y}%`; }
    }

    function updatePlayerLocation(newLocationName) {
        if (gameData.map.pois.some(p => p.name === newLocationName)) {
            gameData.player.location = newLocationName;
            if (document.getElementById('map-panel')?.classList.contains('visible')) {
                updatePlayerMarker();
            }
        }
    }

    // =================================================================
    // 7. Initialization and Global Exposure
    // =================================================================
    function init() {
        // This is the engine starter, ensuring strict execution order
        applyStyles();      // 1. Apply all styles
        createDOM();        // 2. Create all DOM elements in memory
        attachListeners();  // 3. Bind events to the created DOM elements
        
        // --- Expose functions to be called by AI to the global scope ---
        window.enterScene = enterScene;
        window.updateGold = updateGold;
        window.addItemToInventory = addItemToInventory;
        window.removeItemFromInventory = removeItemFromInventory;
        window.advanceTime = advanceTime;
        // ... other functions to be exposed in the future
    }

    // --- Start! ---
    init();

}); // DOMContentLoaded end
</script>

</body>
</html>
